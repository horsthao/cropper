<html>
  <head>
    <title>Butterfly cropping v0.1</title>
    <!-- <link rel=stylesheet type=text/css href="{{ url_for('static', filename='style.css') }}"> -->
    <script src="{{ url_for('static', filename='jquery.js') }}" type="text/javascript"></script>
    <script src="{{ url_for('static', filename='bootstrap.js') }}" type="text/javascript"></script>
    <link rel="stylesheet" href="../static/bootstrap.min.css">
    <!-- <link rel="stylesheet" href="../static/bootstrap.min.css"> -->
    <!-- <link href="../static/test.css" rel="stylesheet"> -->
    <!-- <link href="{{ url_for('static', filename='test.css') }}" rel="stylesheet"> -->
    <link  href="{{ url_for('static', filename='cropper.min.css') }}" rel="stylesheet">
    <script src="{{ url_for('static', filename='cropper.min.js') }}" type="text/javascript"></script>
    <style>
      #popup1 {
        -webkit-box-shadow:  0px 0px 0px 9999px rgba(0, 0, 0, 0.5);
        box-shadow:  0px 0px 0px 9999px rgba(0, 0, 0, 0.5);
      }
      p {margin-bottom:0pt;}
      #container{
        margin-left: 10pt;
        margin-top: 10pt;
        width: 600px;
      }
    </style>
    <script type="text/javascript" language="javascript">
      function wings_checked()
      {
        var chx = document.getElementsByName('topbottom');
        for (var i=0; i<chx.length; i++) {
        // If you have more than one radio group, also check the name attribute
        // for the one you want as in && chx[i].name == 'choose'
        // Return true from the function on first match of a checked item
          if (chx[i].type == 'radio' && chx[i].checked) {
            return true;
          }
        }
      }

      function bad_image()
      {
        console.log(document.getElementById("one_butterfly").checked);
        return !document.getElementById("one_butterfly").checked;
      }

      function cropped()
      {
        return document.getElementById("x").value != "";
      }

      // http://stackoverflow.com/questions/13931688/disable-enable-submit-button-until-all-forms-have-been-filled
      function checkform()
      {
        // here we want to check if we aren't allowed to crop, and if so disable all elements
        // if (bad_image())
        // {
        //     document.querySelector("btn btn-primary").class = "btn btn-primary disabled"
        // }
        // console.log(bad_image())
        var f = document.forms["main_form"].elements;
        var cansubmit = (wings_checked() && cropped()) || bad_image();
        document.getElementById('submitter').disabled = !cansubmit;
      }

      document.addEventListener('keydown', function(event) {
        console.log(event.keyCode)
        if (event.keyCode == 90) { // 90 = 'z'
            document.getElementById("zero_butterflies").checked = "checked";
            checkform();
            document.getElementById("main_form").submit();
        }
      }, true);
    </script>
  </head>
  <body>

  <div id='popup1' class='popup'></div>

  <div id="container">
    <div class="title">
        <h1>Cropping butterflies</h1>
    </div>

    <div id="content">
      <form id="main_form" method="post" action="{{ url_for('form_submission') }}">
        <p>How many butterflies are in the image below?</p>
        <div class="btn-group" id="howmany" data-toggle="buttons">
          <label class="btn btn-primary">
              <input type="radio" name="number_butterflies" id="zero_butterflies"
                value="Zero" onchange="checkform()" >Zero
          </label>
          <label class="btn btn-primary active">
            <input type="radio" name="number_butterflies" checked=""
                value="One" id="one_butterfly" onchange="checkform()" >One
          </label>
          <label class="btn btn-primary" onchange="checkform()" >
            <input type="radio" name="number_butterflies"  value="Many">Many
          </label>
        </div>

        <p>Can you see the top of the wings, the bottom or both?</p>
        <div class="btn-group"  onclick="checkform()"  data-toggle="buttons">
          <label class="btn btn-primary">
            <input type="radio" name="topbottom" value="Top" disabled>Top
          </label>
          <label class="btn btn-primary">
            <input type="radio" name="topbottom" value="Bottom">Bottom
          </label>
          <label class="btn btn-primary">
            <input type="radio" name="topbottom"  value="Both">Both
          </label>
        </div>

        <input type="submit" id="submitter" class="btn btn-primary" disabled/>

        <p>Draw a box around the butterfly:</p>

        <div class="container" id="imageholder" style="color:#0000FF">
          <div id="horizontal"></div>
          <div id="vertical"></div>
          <img width="50%" src="{{ url_for('download_image', sighting_id=sighting_id, img_id=img_id) }}">
        </div>

        <script>
        $('.container > img').cropper({
          //aspectRatio: 16 / 9,
          autoCrop: false,
          viewMode: 1,
          crop: function(e) {
            // Output the result data for cropping image.
            document.getElementById("x").value = e.x;
            document.getElementById("y").value = e.y;
            document.getElementById("width").value = e.width;
            document.getElementById("height").value = e.height;
            document.getElementById("submitter").disabledq = false;
            checkform()
          },
          zoomable: false
        });
        </script>

        <div>
          <input type="text" name="x" id="x" hidden />
          <input type="text" name="y" id="y" hidden />
          <input type="text" name="width" id="width" hidden />
          <input type="text" name="height" id="height" hidden />
          <input type="text" name="sighting_id" id="sighting_id" value={{ sighting_id }} hidden />
          <input type="text" name="img_id" id="img_id" value={{ img_id }} hidden />
          <br/>
          Enter notes here (e.g. 'blurry', 'very small', or 'broken wings'):
          <br/>
          <input type="text" name="notes" size="100" id="notes" class="form-control" />
        </div>

        <br/>
        Sighting ID: {{ sighting_id }}
        <br/>
        Image ID: {{ img_id }}
        <br/>
        <br/>
        <emph>Shortcuts: No butterfly: 'z'</emph>

      </form>
    </div>
  </div>
  </body>
</html>
