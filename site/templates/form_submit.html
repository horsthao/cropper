{% extends "layout.html" %}
{% block head %}
<title>Butterfly cropping v0.1</title>
<link  href="{{ url_for('static', filename='cropper.min.css') }}" rel="stylesheet">
<script src="{{ url_for('static', filename='cropper.min.js') }}" type="text/javascript"></script>
<style>
  .formgroup {
    margin-top: 20px;
  }
  .textboxlabel {
    margin-bottom: 5px;
  }
  p {
    font-size: 12pt;
  }
</style>
<script type="text/javascript" language="javascript">
  function wings_checked()
  {
    var chx = document.getElementsByName('topbottom');
    for (var i=0; i<chx.length; i++) {
    // If you have more than one radio group, also check the name attribute
    // for the one you want as in && chx[i].name == 'choose'
    // Return true from the function on first match of a checked item
      if (chx[i].type == 'radio' && chx[i].checked) {
        return true;
      }
    }
  }

  function bad_image()
  {
    return !document.getElementById("one_butterfly").checked;
  }

  function cropped()
  {
    return document.getElementById("x").value != "";
  }

  // http://stackoverflow.com/questions/13931688/disable-enable-submit-button-until-all-forms-have-been-filled
  function checkform()
  {
    // here we want to check if we aren't allowed to crop, and if so disable all elements
    if (bad_image())
    {
      $(".container > img").cropper("clear");
      $(".img-container > img").cropper("clear");
      $(".img-container > img").cropper("disable");
      $(".popup").show();
      $(".onlyone").css("visibility", "hidden");
      // $("#hiddensubmitter").css("visibility", "visible");
    }
    else {
      // $("#hiddensubmitter").css("visibility", "hidden");
      $(".img-container > img").cropper("enable");
      $(".popup").hide();
      $(".onlyone").css("visibility", "visible");
    }

    var f = document.forms["main_form"].elements;
    var cansubmit = (wings_checked() && cropped()) || bad_image();
    document.getElementById('submitter').disabled = !cansubmit;
  }

  document.addEventListener('keydown', function(event) {
    console.log(event.keyCode)
    if (event.keyCode == 90) { // 90 = 'z'
        document.getElementById("zero_butterflies").checked = "checked";
        checkform();
        document.getElementById("main_form").submit();
    }
  }, true);
</script>
{% endblock %}

{% block body %}
<div id='popup1' class='popup'></div>

<div id="container">
  <!-- <div class="title">
      <h1>Cropping butterflies</h1>
  </div> -->

  <div id="content">
    <form id="main_form" method="post" action="{{ url_for('form_submission') }}">

      <div class="formgroup">
        <p class="textboxlabel">How many butterflies are in the image below?</p>
        <span class="btn-group" id="howmany" data-toggle="buttons">
          <label class="btn btn-default">
              <input type="radio" name="number_butterflies" id="zero_butterflies"
                value="Zero" onchange="checkform()" >Zero
          </label>
          <label class="btn btn-default active">
            <input type="radio" name="number_butterflies" checked=""
                value="One" id="one_butterfly" onchange="checkform()" >One
          </label>
          <label class="btn btn-default" onchange="checkform()" >
            <input type="radio" name="number_butterflies"  value="Many">Many
          </label>
        </span>
        <span style="margin-left: 30px;">
          <!-- <label class="btn btn-primary"> -->
            <button type="submit" id="submitter" class="btn btn-primary">Submit</button>
          <!-- </label> -->
        </span>
      </div>

      <div class="onlyone formgroup">
        <p  class="textboxlabel">Can you see the top of the wings, the bottom or both?</p>
        <div class="btn-group"  data-toggle="buttons">
          <label class="btn btn-default wing-side">
            <input type="radio" name="topbottom" value="Top" onchange="checkform()">Top
          </label>
          <label class="btn btn-default wing-side">
            <input type="radio" name="topbottom" onchange="checkform()" value="Bottom">Bottom
          </label>
          <label class="btn btn-default wing-side">
            <input type="radio" name="topbottom" onchange="checkform()" value="Both">Both
          </label>
        </div>
      </div>

      <div class="formgroup">
        <p class="onlyone textboxlabel">Please draw a box tightly cropping the butterfly's wings:</p>
        <div class="img-container" id="imageholder" style="color:#0000FF">
          <div id="horizontal"></div>
          <div id="vertical"></div>
          <img width="100%" src="{{ url_for('download_image', sighting_id=sighting_id, img_id=img_id) }}">
        </div>
      </div>

      <script>
      $('.img-container > img').cropper({
        //aspectRatio: 16 / 9,
        autoCrop: false,
        viewMode: 1,
        background: false,
        modal: true,
        guides: false,
        crop: function(e) {
          // Output the result data for cropping image.
          document.getElementById("x").value = e.x;
          document.getElementById("y").value = e.y;
          document.getElementById("width").value = e.width;
          document.getElementById("height").value = e.height;
          document.getElementById("submitter").disabledq = false;
          checkform()
        },
        zoomable: false
      });
      </script>

      <div class="formgroup">
        <input type="text" name="x" id="x" hidden />
        <input type="text" name="y" id="y" hidden />
        <input type="text" name="width" id="width" hidden />
        <input type="text" name="height" id="height" hidden />
        <input type="text" name="sighting_id" id="sighting_id" value={{ sighting_id }} hidden />
        <input type="text" name="img_id" id="img_id" value={{ img_id }} hidden />
        <p  class="onlyone textboxlabel">Enter notes here
          <span class="grey">&mdash; e.g. 'blurry', 'very small', or 'broken wings'</span>
        </p>
        <input type="text" name="notes" size="100" id="notes" class="form-control onlyone" />
      </div>

      <hr/>

      <p>Sighting ID: {{ sighting_id }}</p>
      <p>Image ID: {{ img_id }}</p>
      <p><emph>Shortcuts: No butterfly: 'z'</emph></p>

    </form>
  </div>
</div>
{% endblock %}
